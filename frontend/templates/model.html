<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Model Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="assets/style.css" />

    <style>
      body {
        background-color: #d7ebe4ff;
        color: #1a202c;
      }
      .score-badge {
        font-size: 0.9rem;
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
      }
      .score-badge.good {
        background-color: #e6f4ea;
        color: #137333;
      }
      .score-badge.warn {
        background-color: #fef7e0;
        color: #b06000;
      }
      .score-badge.bad {
        background-color: #fce8e6;
        color: #c5221f;
      }
      .section-card {
        margin-bottom: 1rem;
      }
      .lineage-list {
        max-height: 260px;
        overflow-y: auto;
      }
    </style>
  </head>

  <body>
    <!-- Navbar (same pattern as other pages) -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="index.html">ECE 46100</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="browse.html">AI Database</a>
          </li>
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="reviewsDropdown"
              role="button"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
            >
              Reviews
            </a>
            <div class="dropdown-menu" aria-labelledby="reviewsDropdown">
              <a class="dropdown-item" href="review.html">Submit Review</a>
              <a class="dropdown-item" href="modelReviews.html">Model Reviews</a>
              <a class="dropdown-item" href="thank.html">Help us Improve</a>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="login.html">Profile</a>
          </li>
        </ul>
      </div>
    </nav>

    <main class="container my-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h1 id="model-name" class="h3 mb-1">Loading model...</h1>
          <p id="model-id" class="text-muted mb-0" aria-live="polite"></p>
        </div>
        <div>
          <a href="browse.html" class="btn btn-outline-secondary btn-sm"
            >&larr; Back to Browse</a
          >
        </div>
      </div>

      <div id="model-error" class="alert alert-danger d-none" role="alert">
        Unable to load model. Please try again later.
      </div>

      <div class="row">
        <!-- Left column: scores + meta -->
        <section class="col-md-7" aria-label="Model overview and scores">
          <div class="card section-card">
            <div class="card-body">
              <h2 class="h5">Overview</h2>
              <p id="model-description" class="mb-2 text-muted">
                Loading description...
              </p>

              <dl class="row mb-0">
                <dt class="col-sm-4">Owner</dt>
                <dd class="col-sm-8" id="model-owner">-</dd>

                <dt class="col-sm-4">Created</dt>
                <dd class="col-sm-8" id="model-created">-</dd>

                <dt class="col-sm-4">Last Updated</dt>
                <dd class="col-sm-8" id="model-updated">-</dd>

                <dt class="col-sm-4">Tags</dt>
                <dd class="col-sm-8" id="model-tags">-</dd>
              </dl>
            </div>
          </div>

          <div class="card section-card">
            <div class="card-body">
              <h2 class="h5 mb-3">Scores</h2>
              <div class="row">
                <div class="col-sm-6 mb-2">
                  <span class="d-block text-muted small">Overall Score</span>
                  <span id="score-overall" class="score-badge">-</span>
                </div>
                <div class="col-sm-6 mb-2">
                  <span class="d-block text-muted small">Latency</span>
                  <span id="score-latency" class="score-badge">-</span>
                </div>
                <div class="col-sm-6 mb-2">
                  <span class="d-block text-muted small">Reproducibility</span>
                  <span id="score-repro" class="score-badge">-</span>
                </div>
                <div class="col-sm-6 mb-2">
                  <span class="d-block text-muted small">Reviewedness</span>
                  <span id="score-reviewedness" class="score-badge">-</span>
                </div>
                <div class="col-sm-6 mb-2">
                  <span class="d-block text-muted small">TreeScore</span>
                  <span id="score-treescore" class="score-badge">-</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Rating for this specific model -->
          <div class="card section-card">
            <div class="card-body">
              <h2 class="h5 mb-3">Rate this Model</h2>
              <p class="small text-muted">
                These ratings can be aggregated into the model’s overall
                “reviewedness” and quality metrics.
              </p>
              <form id="rate-model-form" class="form-inline" aria-label="Rate this model">
                <label class="sr-only" for="rate-score">Score (1–10)</label>
                <input
                  type="number"
                  min="1"
                  max="10"
                  id="rate-score"
                  class="form-control mr-2 mb-2"
                  placeholder="1–10"
                  required
                />
                <label class="sr-only" for="rate-notes">Notes</label>
                <input
                  type="text"
                  id="rate-notes"
                  class="form-control mr-2 mb-2"
                  placeholder="Short note (optional)"
                />
                <button type="submit" class="btn btn-primary mb-2">
                  Submit Rating
                </button>
              </form>
              <div
                id="rate-feedback"
                class="small mt-2"
                aria-live="polite"
              ></div>
            </div>
          </div>
        </section>

        <!-- Right column: size/portability, license, lineage, downloads -->
        <section class="col-md-5" aria-label="Technical details and lineage">
          <div class="card section-card">
            <div class="card-body">
              <h2 class="h5 mb-3">Size &amp; Portability</h2>
              <p class="mb-1">
                <strong>Model Size:</strong>
                <span id="model-size">-</span>
              </p>
              <p class="mb-1">
                <strong>Estimated Download Cost:</strong>
                <span id="model-size-cost">-</span>
              </p>
              <p class="mb-0 small text-muted">
                Cost estimate is based on configured egress pricing in the
                backend.
              </p>
            </div>
          </div>

          <div class="card section-card">
            <div class="card-body">
              <h2 class="h5 mb-3">License Compatibility</h2>
              <form id="license-form">
                <div class="form-group">
                  <label for="license-project-url">
                    Project repository or license URL
                  </label>
                  <input
                    type="url"
                    id="license-project-url"
                    class="form-control"
                    placeholder="https://github.com/your-org/your-project"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-outline-primary btn-sm">
                  Check Compatibility
                </button>
              </form>
              <div
                id="license-result"
                class="mt-2 small"
                aria-live="polite"
              ></div>
            </div>
          </div>

          <div class="card section-card">
            <div class="card-body">
              <h2 class="h5 mb-3">Lineage</h2>
              <p class="small text-muted">
                Shows models this one depends on or was derived from.
              </p>
              <ul id="lineage-list" class="list-group lineage-list"></ul>
            </div>
          </div>

          <div class="card section-card">
            <div class="card-body">
              <h2 class="h5 mb-3">Downloads</h2>
              <p class="small text-muted">
                Choose what to download. Actual URLs are provided by the backend.
              </p>
              <div class="btn-group-vertical w-100" role="group">
                <button
                  id="download-all-btn"
                  type="button"
                  class="btn btn-success btn-sm mb-1"
                >
                  Download Full Package
                </button>
                <button
                  id="download-weights-btn"
                  type="button"
                  class="btn btn-outline-success btn-sm mb-1"
                >
                  Download Weights Only
                </button>
                <button
                  id="download-datasets-btn"
                  type="button"
                  class="btn btn-outline-success btn-sm"
                >
                  Download Datasets Only
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="text-center py-3 bg-light">
      <p class="mb-0">&copy; 2025 ECE 46100 – AI Database</p>
    </footer>

    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>

    <script>
      const API_BASE =
        "https://sm90vexhij.execute-api.us-east-2.amazonaws.com/Initial";

      function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      function classifyScore(value) {
        if (value == null || isNaN(value)) return "bad";
        const v = Number(value);
        if (v >= 0.75) return "good";
        if (v >= 0.5) return "warn";
        return "bad";
      }

      function setScoreBadge(el, value) {
        el.textContent =
          value == null || value === "" ? "-" : Number(value).toFixed(2);
        el.classList.remove("good", "warn", "bad");
        el.classList.add(classifyScore(value));
      }

      async function loadModel() {
        const modelId = getQueryParam("id");
        if (!modelId) {
          document.getElementById("model-error").classList.remove("d-none");
          document.getElementById("model-error").textContent =
            "Missing model ID in URL.";
          return;
        }

        document.getElementById(
          "model-id"
        ).textContent = `Model ID: ${modelId}`;

        try {
          // Adjust path to your backend’s actual model detail endpoint.
          const res = await fetch(`${API_BASE}/models/${encodeURIComponent(modelId)}`);
          if (!res.ok) throw new Error("Failed to fetch model");
          const model = await res.json();

          // Expecting a structure like:
          // {
          //   "id": "...",
          //   "name": "...",
          //   "description": "...",
          //   "owner": "...",
          //   "created_at": "...",
          //   "updated_at": "...",
          //   "tags": ["..."],
          //   "scores": {
          //      "overall": 0.8,
          //      "latency": 0.7,
          //      "reproducibility": 0.9,
          //      "reviewedness": 0.6,
          //      "treescore": 0.85
          //   },
          //   "size_bytes": 123456789,
          //   "egress_cost_estimate": 0.12
          // }

          document.getElementById("model-name").textContent =
            model.name || "Unnamed Model";
          document.getElementById("model-description").textContent =
            model.description || "No description available.";
          document.getElementById("model-owner").textContent =
            model.owner || "-";
          document.getElementById("model-created").textContent =
            model.created_at || "-";
          document.getElementById("model-updated").textContent =
            model.updated_at || "-";
          document.getElementById("model-tags").textContent =
            Array.isArray(model.tags) && model.tags.length
              ? model.tags.join(", ")
              : "-";

          const scores = model.scores || {};
          setScoreBadge(
            document.getElementById("score-overall"),
            scores.overall
          );
          setScoreBadge(
            document.getElementById("score-latency"),
            scores.latency
          );
          setScoreBadge(
            document.getElementById("score-repro"),
            scores.reproducibility
          );
          setScoreBadge(
            document.getElementById("score-reviewedness"),
            scores.reviewedness
          );
          setScoreBadge(
            document.getElementById("score-treescore"),
            scores.treescore
          );

          // Size & cost
          const sizeEl = document.getElementById("model-size");
          if (model.size_bytes != null) {
            const bytes = Number(model.size_bytes);
            const mb = bytes / (1024 * 1024);
            const gb = mb / 1024;
            sizeEl.textContent =
              gb >= 1
                ? `${gb.toFixed(2)} GB`
                : mb >= 1
                ? `${mb.toFixed(2)} MB`
                : `${bytes} bytes`;
          } else {
            sizeEl.textContent = "-";
          }

          document.getElementById("model-size-cost").textContent =
            model.egress_cost_estimate != null
              ? `$${Number(model.egress_cost_estimate).toFixed(2)}`
              : "-";

          // Load lineage
          await loadLineage(modelId);
          // Wire download buttons
          wireDownloads(modelId);
          // Wire rating form
          wireRatingForm(modelId);
          // Wire license check
          wireLicenseForm(modelId);
        } catch (err) {
          console.error(err);
          document.getElementById("model-error").classList.remove("d-none");
        }
      }

      async function loadLineage(modelId) {
        const list = document.getElementById("lineage-list");
        list.innerHTML =
          '<li class="list-group-item text-muted">Loading lineage...</li>';

        try {
          const res = await fetch(
            `${API_BASE}/models/${encodeURIComponent(modelId)}/lineage`
          );
          if (!res.ok) throw new Error("Lineage fetch failed");
          const data = await res.json();
          const parents = data.parents || [];

          list.innerHTML = "";

          if (!parents.length) {
            list.innerHTML =
              '<li class="list-group-item text-muted">No lineage information available.</li>';
            return;
          }

          parents.forEach((p) => {
            const li = document.createElement("li");
            li.className =
              "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
              <span>
                <strong>${p.name || p.id}</strong>
                <span class="text-muted small d-block">${
                  p.id || "Unknown ID"
                }</span>
              </span>
              <a href="model.html?id=${encodeURIComponent(
                p.id
              )}" class="btn btn-sm btn-outline-secondary">
                View
              </a>
            `;
            list.appendChild(li);
          });
        } catch (err) {
          console.error(err);
          list.innerHTML =
            '<li class="list-group-item text-danger">Error loading lineage.</li>';
        }
      }

      function wireDownloads(modelId) {
        function openDownload(kind) {
          // Backend should return a redirect or signed URL
          const url = `${API_BASE}/models/${encodeURIComponent(
            modelId
          )}/download?asset=${encodeURIComponent(kind)}`;
          window.location.href = url;
        }

        document
          .getElementById("download-all-btn")
          .addEventListener("click", () => openDownload("all"));
        document
          .getElementById("download-weights-btn")
          .addEventListener("click", () => openDownload("weights"));
        document
          .getElementById("download-datasets-btn")
          .addEventListener("click", () => openDownload("datasets"));
      }

      function wireRatingForm(modelId) {
        const form = document.getElementById("rate-model-form");
        const feedback = document.getElementById("rate-feedback");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          feedback.textContent = "Submitting rating...";
          const score = Number(document.getElementById("rate-score").value);
          const notes = document.getElementById("rate-notes").value.trim();

          try {
            const res = await fetch(
              `${API_BASE}/models/${encodeURIComponent(modelId)}/rate`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ score, notes }),
              }
            );
            if (!res.ok) throw new Error("Rating failed");
            feedback.textContent = "Thank you for your rating!";
            form.reset();
            // Optionally reload scores from backend
            await loadModel();
          } catch (err) {
            console.error(err);
            feedback.textContent =
              "Error submitting rating. Please try again later.";
          }
        });
      }

      function wireLicenseForm(modelId) {
        const form = document.getElementById("license-form");
        const resultEl = document.getElementById("license-result");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          resultEl.textContent = "Checking license compatibility...";

          const projectUrl = document
            .getElementById("license-project-url")
            .value.trim();

          try {
            const res = await fetch(
              `${API_BASE}/models/${encodeURIComponent(
                modelId
              )}/license-check`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ project_url: projectUrl }),
              }
            );
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || "Check failed");

            const compatible = data.compatible;
            const message =
              data.message ||
              (compatible
                ? "This model is compatible with the provided project/license."
                : "This model is NOT compatible with the provided project/license.");

            resultEl.textContent = message;
            resultEl.className = `mt-2 small ${
              compatible ? "text-success" : "text-danger"
            }`;
          } catch (err) {
            console.error(err);
            resultEl.textContent =
              "Error checking license. Please try again later.";
            resultEl.className = "mt-2 small text-danger";
          }
        });
      }

      loadModel();
    </script>
  </body>
</html>
